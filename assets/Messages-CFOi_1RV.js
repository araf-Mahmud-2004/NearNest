import{j as e}from"./ui-JykPZCXU.js";import{r as i}from"./vendor-o8UMtg5z.js";import{C as I,b as O,c as re,a as h}from"./card-BPC4h2rA.js";import{I as ie,B as u}from"./input-DSoQLqVb.js";import{T as ce}from"./textarea-BQPmEDNz.js";import{N as L,M as g,B as V,S as ne,e as N,A as $,b as z,c as B,U,l as F,m as K,o as Q,p as H}from"./Navbar-DXhC-Htt.js";import{S as q}from"./scroll-area-amglafIa.js";import{C as G,f as v,S as J}from"./timeUtils-BE1il1GG.js";import{c as le,a as b,g as de,b as oe}from"./index-DOD6g3cj.js";import{u as me,T as xe,S as he,m as p}from"./useMessaging-CuoBxPiu.js";import{a as ue}from"./router-DZ6VJzti.js";import{A as pe}from"./arrow-left-ZkvyHdYd.js";import"./index-BdQq_4o_.js";import"./utils-Bsf8JV-l.js";import"./supabase-DllsxF6L.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const W=le("EllipsisVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]),je=de("relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground",{variants:{variant:{default:"bg-background text-foreground",destructive:"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive"}},defaultVariants:{variant:"default"}}),X=i.forwardRef(({className:a,variant:c,...n},o)=>e.jsx("div",{ref:o,role:"alert",className:b(je({variant:c}),a),...n}));X.displayName="Alert";const fe=i.forwardRef(({className:a,...c},n)=>e.jsx("h5",{ref:n,className:b("mb-1 font-medium leading-none tracking-tight",a),...c}));fe.displayName="AlertTitle";const Y=i.forwardRef(({className:a,...c},n)=>e.jsx("div",{ref:n,className:b("text-sm [&_p]:leading-relaxed",a),...c}));Y.displayName="AlertDescription";const Pe=()=>{const{user:a}=oe();ue();const{conversations:c,messages:n,unreadCount:o,loading:Z,sending:y,error:j,sendMessage:ee,loadMessages:w,markAsRead:f,deleteMessage:se,searchMessages:S}=me(),[t,C]=i.useState(null),[m,_]=i.useState(""),[d,k]=i.useState(""),[M,x]=i.useState([]),[te,A]=i.useState(!1),T=i.useRef(null);i.useEffect(()=>{T.current?.scrollIntoView({behavior:"smooth"})},[n,t]),i.useEffect(()=>{t&&(w(t.id),f(t.id))},[t,w,f]),i.useEffect(()=>{const r=setTimeout(async()=>{if(d.trim()){A(!0);try{const l=await S(d);x(l)}catch(l){console.error("Search error:",l),x([])}finally{A(!1)}}else x([])},300);return()=>clearTimeout(r)},[d,S]);const D=async()=>{if(!m.trim()||!t||!a)return;const s=p.getOtherParticipant(t,a.id);(await ee({recipient_id:s.id,subject:"Message",content:m.trim()})).success&&_("")},E=s=>{C(s),k(""),x([])},ae=async s=>{t&&await se(s,t.id)},P=s=>{if(!a)return"Unknown";const r=p.getOtherParticipant(s,a.id);return p.getDisplayName(r.profile)},R=s=>a?p.getOtherParticipant(s,a.id).profile?.avatar_url:null;return a?e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(L,{}),e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground mb-2",children:"Messages"}),e.jsx("p",{className:"text-muted-foreground",children:"Stay connected with your community"})]}),j&&e.jsxs(X,{variant:"destructive",className:"mb-6",children:[e.jsx(G,{className:"h-4 w-4"}),e.jsxs(Y,{children:[j,". The messaging tables might not be set up yet. Please run the database setup script."]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-200px)]",children:[e.jsxs(I,{className:"lg:col-span-1",children:[e.jsxs(O,{className:"pb-3",children:[e.jsxs(re,{className:"flex items-center gap-2",children:[e.jsx(g,{className:"h-5 w-5"}),"Conversations",o>0&&e.jsx(V,{variant:"destructive",className:"ml-auto",children:o})]}),e.jsxs("div",{className:"relative",children:[e.jsx(ne,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-muted-foreground h-4 w-4"}),e.jsx(ie,{placeholder:"Search messages...",value:d,onChange:s=>k(s.target.value),className:"pl-10"})]})]}),e.jsx(h,{className:"p-0",children:e.jsx(q,{className:"h-[calc(100vh-350px)]",children:Z?e.jsxs("div",{className:"flex items-center justify-center py-8",children:[e.jsx(N,{className:"h-6 w-6 animate-spin"}),e.jsx("span",{className:"ml-2 text-sm text-muted-foreground",children:"Loading..."})]}):j?e.jsxs("div",{className:"p-4 text-center",children:[e.jsx(G,{className:"h-12 w-12 mx-auto text-muted-foreground mb-3"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Unable to load conversations"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Database tables may not be set up"})]}):d?e.jsxs("div",{className:"p-4",children:[e.jsx("h4",{className:"text-sm font-medium mb-3",children:"Search Results"}),te?e.jsx("div",{className:"flex items-center justify-center py-4",children:e.jsx(N,{className:"h-4 w-4 animate-spin"})}):M.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"No messages found"}):e.jsx("div",{className:"space-y-2",children:M.map(s=>e.jsxs("div",{className:"p-3 rounded-lg border hover:bg-muted/50 cursor-pointer",onClick:()=>{const r=c.find(l=>l.participant_1_id===s.sender_id||l.participant_2_id===s.sender_id||l.participant_1_id===s.recipient_id||l.participant_2_id===s.recipient_id);r&&E(r)},children:[e.jsx("p",{className:"text-sm font-medium truncate",children:s.subject}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:s.content}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:v(s.created_at)})]},s.id))})]}):c.length===0?e.jsxs("div",{className:"p-4 text-center",children:[e.jsx(g,{className:"h-12 w-12 mx-auto text-muted-foreground mb-3"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"No conversations yet"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Start messaging by contacting someone from a listing or event"})]}):e.jsx("div",{className:"space-y-1",children:c.map(s=>e.jsx("div",{className:`p-4 hover:bg-muted/50 cursor-pointer transition-colors ${t?.id===s.id?"bg-muted":""}`,onClick:()=>E(s),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs($,{className:"h-10 w-10",children:[e.jsx(z,{src:R(s)||void 0}),e.jsx(B,{children:e.jsx(U,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"font-medium text-sm truncate",children:P(s)}),s.unread_count&&s.unread_count>0&&e.jsx(V,{variant:"destructive",className:"text-xs",children:s.unread_count})]}),s.last_message&&e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:s.last_message.content}),e.jsx("p",{className:"text-xs text-muted-foreground",children:v(s.last_message_at)})]})]})},s.id))})})})]}),e.jsx(I,{className:"lg:col-span-2",children:t?e.jsxs(e.Fragment,{children:[e.jsx(O,{className:"pb-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(u,{variant:"ghost",size:"sm",onClick:()=>C(null),className:"lg:hidden",children:e.jsx(pe,{className:"h-4 w-4"})}),e.jsxs($,{className:"h-8 w-8",children:[e.jsx(z,{src:R(t)||void 0}),e.jsx(B,{children:e.jsx(U,{className:"h-4 w-4"})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold",children:P(t)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Active conversation"})]})]}),e.jsxs(F,{children:[e.jsx(K,{asChild:!0,children:e.jsx(u,{variant:"ghost",size:"sm",children:e.jsx(W,{className:"h-4 w-4"})})}),e.jsx(Q,{align:"end",children:e.jsx(H,{onClick:()=>f(t.id),children:"Mark as read"})})]})]})}),e.jsx(J,{}),e.jsx(h,{className:"p-0",children:e.jsx(q,{className:"h-[calc(100vh-450px)] p-4",children:e.jsxs("div",{className:"space-y-4",children:[n[t.id]?.map(s=>{const r=s.sender_id===a.id;return e.jsx("div",{className:`flex ${r?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[70%] ${r?"order-2":"order-1"}`,children:[e.jsxs("div",{className:`p-3 rounded-lg ${r?"bg-primary text-primary-foreground":"bg-muted text-muted-foreground"}`,children:[s.subject!=="Message"&&e.jsx("p",{className:"text-xs font-medium mb-1 opacity-80",children:s.subject}),e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s.content}),s.post_title&&e.jsxs("div",{className:"mt-2 p-2 rounded bg-black/10 text-xs",children:[e.jsxs("p",{className:"font-medium",children:["Re: ",s.post_title]}),e.jsx("p",{className:"opacity-80",children:s.post_type==="listing"?"Marketplace Listing":"Community Event"})]})]}),e.jsxs("div",{className:`flex items-center gap-2 mt-1 ${r?"justify-end":"justify-start"}`,children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:v(s.created_at)}),r&&e.jsxs(F,{children:[e.jsx(K,{asChild:!0,children:e.jsx(u,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",children:e.jsx(W,{className:"h-3 w-3"})})}),e.jsx(Q,{align:"end",children:e.jsxs(H,{onClick:()=>ae(s.id),className:"text-destructive",children:[e.jsx(xe,{className:"h-3 w-3 mr-2"}),"Delete"]})})]})]})]})},s.id)}),e.jsx("div",{ref:T})]})})}),e.jsx(J,{}),e.jsxs(h,{className:"p-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx(ce,{placeholder:"Type your message...",value:m,onChange:s=>_(s.target.value),onKeyDown:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),D())},className:"min-h-[60px] resize-none"}),e.jsx(u,{onClick:D,disabled:!m.trim()||y,className:"self-end",children:y?e.jsx(N,{className:"h-4 w-4 animate-spin"}):e.jsx(he,{className:"h-4 w-4"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Press Enter to send, Shift+Enter for new line"})]})]}):e.jsx(h,{className:"flex items-center justify-center h-full",children:e.jsxs("div",{className:"text-center",children:[e.jsx(g,{className:"h-16 w-16 mx-auto text-muted-foreground mb-4"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Select a conversation"}),e.jsx("p",{className:"text-muted-foreground",children:"Choose a conversation from the list to start messaging"})]})})})]})]})]}):e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(L,{}),e.jsx("div",{className:"flex items-center justify-center h-96",children:e.jsx("p",{className:"text-muted-foreground",children:"Please log in to view messages."})})]})};export{Pe as default};
