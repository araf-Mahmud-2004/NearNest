import{a as Ue,m as de,n as Me,b as $e,j as e,o as Ve,P as V,p as ze,I as Fe,f as q,d as Oe}from"./ui-JykPZCXU.js";import{r as l}from"./vendor-o8UMtg5z.js";import{B as T}from"./input-CIthbtd8.js";import{C as y,a as w,b as L,c as D}from"./card-nPJQNN0C.js";import{c as z,a as K,s as g,b as J,u as ue,d as qe,e as ne}from"./index-DFAoHlto.js";import{n as re,M as me,H as he,A as Be,b as We,c as He,U as xe,B as Ge,N as Ke,P as Je,a as B,L as ie,d as Ye}from"./Navbar-BlvArtp8.js";import{E as I}from"./eye-5zhaSkUZ.js";import{U as Qe,R as Xe,E as Ze,a as ce}from"./ErrorBoundary-Ow1ob57h.js";import{S as et}from"./scroll-area-B_wjsOKc.js";import{f as oe,S as tt}from"./timeUtils-BYBrqawd.js";import{a as fe}from"./router-DZ6VJzti.js";import{M as W}from"./map-pin-YEAOFdVc.js";import"./supabase-BdK7WG9U.js";import"./utils-Bsf8JV-l.js";import"./index-BdQq_4o_.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=z("Activity",[["path",{d:"M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2",key:"169zse"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const st=z("TrendingUp",[["polyline",{points:"22 7 13.5 15.5 8.5 10.5 2 17",key:"126l90"}],["polyline",{points:"16 7 22 7 22 13",key:"kwv8wd"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const at=z("WifiOff",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const nt=z("Wifi",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]]);var Y="Tabs",[rt,It]=Ue(Y,[de]),pe=de(),[it,Q]=rt(Y),ge=l.forwardRef((n,a)=>{const{__scopeTabs:t,value:s,onValueChange:r,defaultValue:i,orientation:c="horizontal",dir:h,activationMode:x="automatic",...d}=n,o=Me(h),[u,f]=$e({prop:s,onChange:r,defaultProp:i});return e.jsx(it,{scope:t,baseId:Ve(),value:u,onValueChange:f,orientation:c,dir:o,activationMode:x,children:e.jsx(V.div,{dir:o,"data-orientation":c,...d,ref:a})})});ge.displayName=Y;var be="TabsList",ve=l.forwardRef((n,a)=>{const{__scopeTabs:t,loop:s=!0,...r}=n,i=Q(be,t),c=pe(t);return e.jsx(ze,{asChild:!0,...c,orientation:i.orientation,dir:i.dir,loop:s,children:e.jsx(V.div,{role:"tablist","aria-orientation":i.orientation,...r,ref:a})})});ve.displayName=be;var je="TabsTrigger",ye=l.forwardRef((n,a)=>{const{__scopeTabs:t,value:s,disabled:r=!1,...i}=n,c=Q(je,t),h=pe(t),x=_e(c.baseId,s),d=ke(c.baseId,s),o=s===c.value;return e.jsx(Fe,{asChild:!0,...h,focusable:!r,active:o,children:e.jsx(V.button,{type:"button",role:"tab","aria-selected":o,"aria-controls":d,"data-state":o?"active":"inactive","data-disabled":r?"":void 0,disabled:r,id:x,...i,ref:a,onMouseDown:q(n.onMouseDown,u=>{!r&&u.button===0&&u.ctrlKey===!1?c.onValueChange(s):u.preventDefault()}),onKeyDown:q(n.onKeyDown,u=>{[" ","Enter"].includes(u.key)&&c.onValueChange(s)}),onFocus:q(n.onFocus,()=>{const u=c.activationMode!=="manual";!o&&!r&&u&&c.onValueChange(s)})})})});ye.displayName=je;var we="TabsContent",Ne=l.forwardRef((n,a)=>{const{__scopeTabs:t,value:s,forceMount:r,children:i,...c}=n,h=Q(we,t),x=_e(h.baseId,s),d=ke(h.baseId,s),o=s===h.value,u=l.useRef(o);return l.useEffect(()=>{const f=requestAnimationFrame(()=>u.current=!1);return()=>cancelAnimationFrame(f)},[]),e.jsx(Oe,{present:r||o,children:({present:f})=>e.jsx(V.div,{"data-state":o?"active":"inactive","data-orientation":h.orientation,role:"tabpanel","aria-labelledby":x,hidden:!f,id:d,tabIndex:0,...c,ref:a,style:{...n.style,animationDuration:u.current?"0s":void 0},children:f&&i})})});Ne.displayName=we;function _e(n,a){return`${n}-trigger-${a}`}function ke(n,a){return`${n}-content-${a}`}var ct=ge,Se=ve,Ce=ye,Ee=Ne;const ot=ct,Te=l.forwardRef(({className:n,...a},t)=>e.jsx(Se,{ref:t,className:K("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",n),...a}));Te.displayName=Se.displayName;const H=l.forwardRef(({className:n,...a},t)=>e.jsx(Ce,{ref:t,className:K("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",n),...a}));H.displayName=Ce.displayName;const G=l.forwardRef(({className:n,...a},t)=>e.jsx(Ee,{ref:t,className:K("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",n),...a}));G.displayName=Ee.displayName;const $={async logInteraction(n){const{data:a,error:t}=await g.from("user_interactions").insert(n).select("*").single();return{data:a,error:t}},async trackView(n,a,t){const{data:{user:s}}=await g.auth.getUser();!s||s.id===t||await this.logInteraction({user_id:s.id,post_id:n,post_type:a,interaction_type:"view",metadata:{timestamp:new Date().toISOString()}})},async trackContact(n,a,t,s,r){const{data:{user:i}}=await g.auth.getUser();if(i&&(await this.logInteraction({user_id:i.id,post_id:n,post_type:a,interaction_type:"contact",metadata:{contact_method:s,timestamp:new Date().toISOString()}}),t!==i.id)){const{data:c}=await g.from("profiles").select("username, full_name").eq("id",i.id).single(),h=c?.full_name||c?.username||"Someone";await re.createNotification({user_id:t,type:"contact",title:`${h} wants to contact you!`,message:`${h} is interested in contacting you about "${r||"your post"}"`,data:{post_id:n,post_type:a,post_title:r,contact_method:s,interested_user_id:i.id}})}},async trackInterest(n,a,t,s){const{data:{user:r}}=await g.auth.getUser();if(r&&(await this.logInteraction({user_id:r.id,post_id:n,post_type:a,interaction_type:"interest",metadata:{timestamp:new Date().toISOString()}}),t!==r.id)){const{data:i}=await g.from("profiles").select("username, full_name").eq("id",r.id).single(),c=i?.full_name||i?.username||"Someone";await re.createNotification({user_id:t,type:"interest",title:`${c} is interested in your ${a}!`,message:`${c} showed interest in "${s||"your post"}"`,data:{post_id:n,post_type:a,post_title:s,interested_user_id:r.id}})}},async trackProfileView(n){const{data:{user:a}}=await g.auth.getUser();!a||a.id===n||await this.logInteraction({user_id:a.id,post_id:n,post_type:"listing",interaction_type:"profile_view",metadata:{timestamp:new Date().toISOString()}})},async getRecentActivity(n,a=20){const{data:t}=await g.from("listings").select("id, title, user_id").eq("user_id",n),{data:s}=await g.from("events").select("id, title, user_id").eq("user_id",n),r=[...(t||[]).map(x=>x.id),...(s||[]).map(x=>x.id)];if(r.length===0)return{data:[],error:null};const{data:i,error:c}=await g.from("user_interactions").select(`
        *,
        profiles:user_id (
          id,
          username,
          full_name,
          avatar_url
        )
      `).in("post_id",r).order("created_at",{ascending:!1}).limit(a);if(c)return{data:null,error:c};const h=[];for(const x of i||[]){let d="Unknown Post",o=n;const u=t?.find(b=>b.id===x.post_id),f=s?.find(b=>b.id===x.post_id);u?(d=u.title,o=u.user_id):f&&(d=f.title,o=f.user_id),h.push({id:x.id,user_id:x.user_id,post_id:x.post_id,post_type:x.post_type,post_title:d,post_owner_id:o,interaction_type:x.interaction_type,created_at:x.created_at,profiles:x.profiles})}return{data:h,error:null}},async getActivityStats(n){const{data:a}=await g.from("listings").select("id").eq("user_id",n),{data:t}=await g.from("events").select("id").eq("user_id",n),s=[...(a||[]).map(d=>d.id),...(t||[]).map(d=>d.id)];if(s.length===0)return{data:{total_views:0,total_contacts:0,total_interests:0,recent_viewers:0},error:null};const{data:r}=await g.from("user_interactions").select("id",{count:"exact"}).in("post_id",s).eq("interaction_type","view"),{data:i}=await g.from("user_interactions").select("id",{count:"exact"}).in("post_id",s).eq("interaction_type","contact"),{data:c}=await g.from("user_interactions").select("id",{count:"exact"}).in("post_id",s).eq("interaction_type","interest"),h=new Date;h.setDate(h.getDate()-1);const{data:x}=await g.from("user_interactions").select("user_id",{count:"exact"}).in("post_id",s).eq("interaction_type","view").gte("created_at",h.toISOString());return{data:{total_views:r?.length||0,total_contacts:i?.length||0,total_interests:c?.length||0,recent_viewers:x?.length||0},error:null}},subscribeToInteractions(n,a){return g.channel(`user_interactions_${n}`).on("postgres_changes",{event:"*",schema:"public",table:"user_interactions",filter:`user_id=eq.${n}`},a).subscribe()},subscribeToPostInteractions(n,a){return g.channel("post_interactions").on("postgres_changes",{event:"*",schema:"public",table:"user_interactions",filter:`post_id=in.(${n.join(",")})`},a).subscribe()}},lt=({userId:n})=>{const{user:a}=J(),[t,s]=l.useState({total_views:0,total_contacts:0,total_interests:0,recent_viewers:0}),[r,i]=l.useState(!0),c=n||a?.id,h=l.useCallback(async()=>{if(c)try{i(!0);const{data:d,error:o}=await $.getActivityStats(c);o?(console.error("Error fetching activity stats:",o),s({total_views:0,total_contacts:0,total_interests:0,recent_viewers:0})):s(d||{total_views:0,total_contacts:0,total_interests:0,recent_viewers:0})}catch(d){console.error("Unexpected error fetching activity stats:",d),s({total_views:0,total_contacts:0,total_interests:0,recent_viewers:0})}finally{i(!1)}},[c]);l.useEffect(()=>{h()},[h]),l.useEffect(()=>{if(!c)return;const d=$.subscribeToInteractions(c,o=>{console.log("Stats update from real-time interaction:",o),h()});return()=>{d.unsubscribe()}},[c,h]);const x=[{title:"Total Views",value:t.total_views,icon:I,color:"text-blue-600",bgColor:"bg-blue-50 dark:bg-blue-950"},{title:"Contacts",value:t.total_contacts,icon:me,color:"text-green-600",bgColor:"bg-green-50 dark:bg-green-950"},{title:"Interests",value:t.total_interests,icon:he,color:"text-red-600",bgColor:"bg-red-50 dark:bg-red-950"},{title:"Recent Viewers",value:t.recent_viewers,icon:Qe,color:"text-purple-600",bgColor:"bg-purple-50 dark:bg-purple-950"}];return r?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[1,2,3,4].map(d=>e.jsx(y,{children:e.jsx(w,{className:"p-6",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4 mb-2"}),e.jsx("div",{className:"h-8 bg-gray-200 rounded w-1/2"})]})})},d))}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:x.map(d=>{const o=d.icon;return e.jsx(y,{className:"hover:shadow-md transition-shadow",children:e.jsx(w,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:d.title}),e.jsx("p",{className:"text-2xl font-bold",children:d.value.toLocaleString()})]}),e.jsx("div",{className:`p-3 rounded-full ${d.bgColor}`,children:e.jsx(o,{className:`h-6 w-6 ${d.color}`})})]})})},d.title)})})},dt=n=>{switch(n){case"view":return e.jsx(I,{className:"h-4 w-4"});case"contact":return e.jsx(me,{className:"h-4 w-4"});case"interest":return e.jsx(he,{className:"h-4 w-4"});case"profile_view":return e.jsx(xe,{className:"h-4 w-4"});default:return e.jsx(I,{className:"h-4 w-4"})}},ut=n=>{switch(n){case"view":return"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300";case"contact":return"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300";case"interest":return"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300";case"profile_view":return"bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300";default:return"bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300"}},mt=n=>{switch(n){case"view":return"viewed";case"contact":return"contacted about";case"interest":return"showed interest in";case"profile_view":return"viewed your profile";default:return"interacted with"}},ht=({userId:n,limit:a=20,showHeader:t=!0})=>{const{user:s}=J(),r=fe(),{toast:i}=ue(),[c,h]=l.useState([]),[x,d]=l.useState(!0),[o,u]=l.useState(null),[f,b]=l.useState(new Date),N=n||s?.id,_=l.useCallback(async()=>{if(N)try{d(!0);const{data:p,error:j}=await $.getRecentActivity(N,a);j?(console.error("Error fetching activities:",j),u("Failed to load recent activity"),h([])):(h(p||[]),u(null),b(new Date))}catch(p){console.error("Unexpected error fetching activities:",p),u("Failed to load recent activity"),h([])}finally{d(!1)}},[N,a]);l.useEffect(()=>{_()},[_]),l.useEffect(()=>{if(!N)return;const p=$.subscribeToPostInteractions([],j=>{if(console.log("Real-time interaction update:",j),_(),j.eventType==="INSERT"&&j.new){const E=j.new;E.interaction_type==="view"?i({title:"New view on your post!",description:"Someone viewed one of your posts"}):E.interaction_type==="interest"?i({title:"Someone showed interest!",description:"Someone is interested in your post"}):E.interaction_type==="contact"&&i({title:"New contact!",description:"Someone contacted you about your post"})}});return()=>{p.unsubscribe()}},[N,_,i]);const U=()=>{_()},C=p=>{r(`/profile/${p}`)},A=(p,j)=>{r(j==="listing"?"/listings":"/events")};return x?e.jsxs(y,{children:[t&&e.jsx(L,{children:e.jsxs(D,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-5 w-5"}),"Recent Activity"]})}),e.jsx(w,{children:e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})})})]}):o?e.jsxs(y,{children:[t&&e.jsx(L,{children:e.jsxs(D,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-5 w-5"}),"Recent Activity"]})}),e.jsx(w,{children:e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:o})})]}):c.length===0?e.jsxs(y,{children:[t&&e.jsx(L,{children:e.jsxs(D,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-5 w-5"}),"Recent Activity"]})}),e.jsx(w,{children:e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No recent activity to show"})})]}):e.jsxs(y,{children:[t&&e.jsx(L,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(D,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-5 w-5"}),"Recent Activity"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Updated ",oe(f.toISOString())]}),e.jsx(T,{variant:"ghost",size:"sm",onClick:U,disabled:x,className:"h-8 w-8 p-0",children:e.jsx(Xe,{className:`h-4 w-4 ${x?"animate-spin":""}`})})]})]})}),e.jsx(w,{className:"p-0",children:e.jsx(et,{className:"h-[400px]",children:e.jsx("div",{className:"p-4 space-y-4",children:c.map((p,j)=>e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsxs(Be,{className:"h-8 w-8 cursor-pointer",onClick:()=>C(p.user_id),children:[e.jsx(We,{src:p.profiles?.avatar_url||void 0}),e.jsx(He,{children:e.jsx(xe,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium text-sm",children:p.profiles?.full_name||p.profiles?.username||"Anonymous"}),e.jsxs(Ge,{variant:"secondary",className:`text-xs ${ut(p.interaction_type)}`,children:[dt(p.interaction_type),e.jsx("span",{className:"ml-1",children:mt(p.interaction_type)})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[p.interaction_type!=="profile_view"?e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:p.post_title}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"Viewed your profile"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:oe(p.created_at)})]}),p.interaction_type!=="profile_view"&&e.jsx(T,{variant:"ghost",size:"sm",onClick:()=>A(p.post_id,p.post_type),className:"ml-2 flex-shrink-0",children:e.jsx(Ze,{className:"h-3 w-3"})})]})]})]}),j<c.length-1&&e.jsx(tt,{className:"mt-4"})]},p.id))})})})]})};class xt{channels=new Map;listeners=new Map;subscribeToUserInteractions(a,t){const s=`user_interactions_${a}`;if(!this.channels.has(s)){const i=g.channel(s).on("postgres_changes",{event:"*",schema:"public",table:"user_interactions",filter:`user_id=eq.${a}`},c=>{const h={type:"interaction",payload:c,timestamp:new Date().toISOString()};this.notifyListeners(s,h)}).subscribe();this.channels.set(s,i),this.listeners.set(s,new Set)}const r=this.listeners.get(s);return r.add(t),()=>{if(r.delete(t),r.size===0){const i=this.channels.get(s);i&&(i.unsubscribe(),this.channels.delete(s),this.listeners.delete(s))}}}subscribeToPostInteractions(a,t){const s=`post_interactions_${a.join("_")}`;if(!this.channels.has(s)){const i=g.channel(s).on("postgres_changes",{event:"*",schema:"public",table:"user_interactions",filter:`post_id=in.(${a.join(",")})`},c=>{const h={type:"interaction",payload:c,timestamp:new Date().toISOString()};this.notifyListeners(s,h)}).subscribe();this.channels.set(s,i),this.listeners.set(s,new Set)}const r=this.listeners.get(s);return r.add(t),()=>{if(r.delete(t),r.size===0){const i=this.channels.get(s);i&&(i.unsubscribe(),this.channels.delete(s),this.listeners.delete(s))}}}subscribeToListings(a){const t="listings_updates";if(!this.channels.has(t)){const r=g.channel(t).on("postgres_changes",{event:"*",schema:"public",table:"listings"},i=>{const c={type:"listing_update",payload:i,timestamp:new Date().toISOString()};this.notifyListeners(t,c)}).subscribe();this.channels.set(t,r),this.listeners.set(t,new Set)}const s=this.listeners.get(t);return s.add(a),()=>{if(s.delete(a),s.size===0){const r=this.channels.get(t);r&&(r.unsubscribe(),this.channels.delete(t),this.listeners.delete(t))}}}subscribeToEvents(a){const t="events_updates";if(!this.channels.has(t)){const r=g.channel(t).on("postgres_changes",{event:"*",schema:"public",table:"events"},i=>{const c={type:"event_update",payload:i,timestamp:new Date().toISOString()};this.notifyListeners(t,c)}).subscribe();this.channels.set(t,r),this.listeners.set(t,new Set)}const s=this.listeners.get(t);return s.add(a),()=>{if(s.delete(a),s.size===0){const r=this.channels.get(t);r&&(r.unsubscribe(),this.channels.delete(t),this.listeners.delete(t))}}}subscribeToProfiles(a){const t="profiles_updates";if(!this.channels.has(t)){const r=g.channel(t).on("postgres_changes",{event:"*",schema:"public",table:"profiles"},i=>{const c={type:"profile_update",payload:i,timestamp:new Date().toISOString()};this.notifyListeners(t,c)}).subscribe();this.channels.set(t,r),this.listeners.set(t,new Set)}const s=this.listeners.get(t);return s.add(a),()=>{if(s.delete(a),s.size===0){const r=this.channels.get(t);r&&(r.unsubscribe(),this.channels.delete(t),this.listeners.delete(t))}}}notifyListeners(a,t){const s=this.listeners.get(a);s&&s.forEach(r=>{try{r(t)}catch(i){console.error("Error in WebSocket listener:",i)}})}cleanup(){this.channels.forEach((a,t)=>{a.unsubscribe()}),this.channels.clear(),this.listeners.clear()}getConnectionStatus(){return"OPEN"}}const R=new xt,ft=(n={})=>{const{onMessage:a,onError:t,enabled:s=!0}=n,r=l.useRef([]),i=l.useCallback((o,u)=>{if(!s)return()=>{};const f=R.subscribeToUserInteractions(o,b=>{try{u?.(b),a?.(b)}catch(N){t?.(N)}});return r.current.push(f),f},[s,a,t]),c=l.useCallback((o,u)=>{if(!s||o.length===0)return()=>{};const f=R.subscribeToPostInteractions(o,b=>{try{u?.(b),a?.(b)}catch(N){t?.(N)}});return r.current.push(f),f},[s,a,t]),h=l.useCallback(o=>{if(!s)return()=>{};const u=R.subscribeToListings(f=>{try{o?.(f),a?.(f)}catch(b){t?.(b)}});return r.current.push(u),u},[s,a,t]),x=l.useCallback(o=>{if(!s)return()=>{};const u=R.subscribeToEvents(f=>{try{o?.(f),a?.(f)}catch(b){t?.(b)}});return r.current.push(u),u},[s,a,t]),d=l.useCallback(o=>{if(!s)return()=>{};const u=R.subscribeToProfiles(f=>{try{o?.(f),a?.(f)}catch(b){t?.(b)}});return r.current.push(u),u},[s,a,t]);return l.useEffect(()=>()=>{r.current.forEach(o=>{try{o()}catch(u){console.error("Error unsubscribing from WebSocket:",u)}}),r.current=[]},[]),{subscribeToUserInteractions:i,subscribeToPostInteractions:c,subscribeToListings:h,subscribeToEvents:x,subscribeToProfiles:d,connectionStatus:R.getConnectionStatus()}},pt=()=>{const{subscribeToListings:n,subscribeToEvents:a,subscribeToProfiles:t}=ft(),s=l.useCallback(c=>n(c),[n]),r=l.useCallback(c=>a(c),[a]),i=l.useCallback(c=>t(c),[t]);return{trackListings:s,trackEvents:r,trackProfiles:i}},At=()=>{const{user:n,username:a,profile:t,loading:s,profileLoading:r}=J(),i=fe(),{toast:c}=ue(),{trackListings:h,trackEvents:x}=pt(),{listings:d,events:o,loading:u,refreshData:f}=qe(),[b,N]=l.useState([]),[_,U]=l.useState([]),[C,A]=l.useState(!0),[p,j]=l.useState(!0),[E,X]=l.useState(new Date),[F,M]=l.useState({activeListings:0,weeklyEvents:0,newMembers:23}),Z=m=>{const v=new Date(m),k=Math.floor((new Date().getTime()-v.getTime())/(1e3*60*60));if(k<1)return"Just now";if(k<24)return`${k} hours ago`;const S=Math.floor(k/24);return S===1?"1 day ago":`${S} days ago`},Le=m=>new Date(m).toLocaleDateString("en-US",{month:"short",day:"numeric"}),ee=l.useCallback(()=>{try{if(A(!0),d&&d.length>0){const m=d.slice(0,5);N(m),M(v=>({...v,activeListings:d.length}))}else N([]),M(m=>({...m,activeListings:0}));if(o&&o.length>0){const m=new Date,v=o.filter(S=>new Date(S.date)>=m).slice(0,5);U(v);const P=new Date;P.setDate(P.getDate()+7);const k=o.filter(S=>{const ae=new Date(S.date);return ae>=m&&ae<=P}).length;M(S=>({...S,weeklyEvents:k}))}else U([]),M(m=>({...m,weeklyEvents:0}));X(new Date),j(!0)}catch(m){console.error("Error processing data:",m),j(!1)}finally{A(!1)}},[d,o]),De=l.useCallback(async()=>{try{A(!0),await f(),c({title:"Data refreshed",description:"Dashboard content has been updated"})}catch(m){console.error("Error refreshing data:",m),c({title:"Refresh failed",description:"Failed to refresh dashboard data",variant:"destructive"})}},[f,c]),O=l.useCallback(()=>{X(new Date),j(!0)},[]),te=()=>{i("/create-listing")},se=()=>{i("/create-event")},Ie=()=>{i("/listings")},Ae=()=>{i("/events")},Re=()=>{i("/listings")},Pe=()=>{i("/events")};return l.useEffect(()=>{!s&&!n&&i("/auth")},[n,s,i]),l.useEffect(()=>{u||ee()},[d,o,u,ee]),l.useEffect(()=>{A(u)},[u]),l.useEffect(()=>{if(!n)return;const m=h(O),v=x(O);return()=>{m(),v()}},[n,h,x,O]),l.useEffect(()=>{const v=setInterval(()=>{const k=new Date().getTime()-E.getTime()>5*60*1e3;j(!k)},3e4);return()=>clearInterval(v)},[E]),s?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-nearnest-green"})}):n?e.jsxs("div",{className:"min-h-screen bg-background text-foreground",children:[e.jsx(Ke,{}),e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsxs("div",{className:"mb-8 animate-fade-in",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Welcome back! 👋"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[p?e.jsx(nt,{className:"h-4 w-4 text-green-500"}):e.jsx(at,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:p?"Live":"Disconnected"})]}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Updated ",Z(E.toISOString())]}),e.jsx(T,{variant:"ghost",size:"sm",onClick:De,disabled:C,className:"h-8 w-8 p-0",children:e.jsx(le,{className:`h-4 w-4 ${C?"animate-spin":""}`})})]})]}),a&&e.jsxs("p",{className:"text-lg text-muted-foreground mb-6",children:["Hello,"," ",e.jsx("span",{className:"font-semibold text-primary",children:a}),"! Ready to explore your neighborhood?"]}),e.jsx("p",{className:"text-muted-foreground",children:"Here's what's happening in your community today."})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8",children:[e.jsx(y,{className:"border-0 shadow-md hover:shadow-lg transition-all duration-300 cursor-pointer bg-gradient-to-br from-primary to-primary/80 hover:scale-105 animate-fade-in",onClick:te,children:e.jsx(w,{className:"p-6",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"w-12 h-12 bg-primary/60 rounded-xl flex items-center justify-center",children:e.jsx(Je,{className:"h-6 w-6 text-primary-foreground"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-primary-foreground",children:"Post Listing"}),e.jsx("p",{className:"text-sm text-primary-foreground/80",children:"Sell something"})]})]})})}),e.jsx(y,{className:"border-0 shadow-md hover:shadow-lg transition-all duration-300 cursor-pointer bg-gradient-to-br from-emerald-500 to-teal-600 dark:from-slate-800 dark:to-blue-900 hover:scale-105 animate-fade-in",onClick:se,style:{animationDelay:"0.1s"},children:e.jsx(w,{className:"p-6",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"w-12 h-12 bg-white/20 dark:bg-white/30 rounded-xl flex items-center justify-center",children:e.jsx(B,{className:"h-6 w-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-white",children:"Create Event"}),e.jsx("p",{className:"text-sm text-white/80 dark:text-white/90",children:"Host something"})]})]})})}),e.jsx(y,{className:"border-0 shadow-md hover:shadow-lg transition-all duration-300 cursor-pointer hover:scale-105 animate-fade-in",onClick:Ie,style:{animationDelay:"0.2s"},children:e.jsx(w,{className:"p-6",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"w-12 h-12 bg-primary rounded-xl flex items-center justify-center",children:e.jsx(ie,{className:"h-6 w-6 text-primary-foreground"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-foreground",children:"Browse Items"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Find great deals"})]})]})})}),e.jsx(y,{className:"border-0 shadow-md hover:shadow-lg transition-all duration-300 cursor-pointer hover:scale-105 animate-fade-in",onClick:Ae,style:{animationDelay:"0.3s"},children:e.jsx(w,{className:"p-6",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"w-12 h-12 bg-primary/80 rounded-xl flex items-center justify-center",children:e.jsx(W,{className:"h-6 w-6 text-primary-foreground"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-foreground",children:"Local Events"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Join activities"})]})]})})})]}),e.jsxs("div",{className:"mb-8 animate-fade-in",style:{animationDelay:"0.4s"},children:[e.jsxs("h2",{className:"text-2xl font-bold text-foreground mb-4 flex items-center gap-2",children:[e.jsx(le,{className:"h-6 w-6"}),"Your Activity"]}),e.jsx(ce,{fallback:e.jsx(y,{children:e.jsx(w,{className:"p-6 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"Activity stats temporarily unavailable"})})}),children:e.jsx(lt,{})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8 animate-fade-in",style:{animationDelay:"0.5s"},children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsxs(ot,{defaultValue:"listings",className:"w-full",children:[e.jsxs(Te,{className:"grid w-full grid-cols-2",children:[e.jsx(H,{value:"listings",children:"Recent Listings"}),e.jsx(H,{value:"activity",children:"Recent Activity"})]}),e.jsx(G,{value:"listings",className:"mt-6",children:e.jsxs(y,{className:"border-0 shadow-md",children:[e.jsx(L,{className:"pb-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(D,{className:"text-xl font-semibold",children:"Recent Listings Near You"}),e.jsx(T,{variant:"ghost",size:"sm",className:"text-primary hover:text-primary/80",onClick:Re,children:"View All"})]})}),e.jsx(w,{className:"space-y-4",children:C?e.jsx("div",{className:"space-y-4",children:[...Array(3)].map((m,v)=>e.jsxs("div",{className:"flex items-center space-x-4 p-4 rounded-lg animate-pulse",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-200 rounded-lg"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded w-1/2"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded w-1/4"})]})]},v))}):b.length>0?b.map(m=>e.jsxs("div",{className:"flex items-center space-x-4 p-4 rounded-lg hover:bg-accent/40 transition-colors duration-200 cursor-pointer",onClick:()=>i("/listings"),children:[e.jsx("img",{src:m.image||"https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=100&h=100&fit=crop",alt:m.title,className:"w-16 h-16 object-cover rounded-lg",onError:v=>{v.target.src="https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=100&h=100&fit=crop"}}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-medium text-foreground truncate",children:m.title}),e.jsxs("div",{className:"flex items-center space-x-4 mt-1",children:[e.jsxs("span",{className:"text-lg font-semibold text-primary",children:["$",m.price]}),e.jsxs("span",{className:"text-sm text-muted-foreground flex items-center",children:[e.jsx(W,{className:"h-3 w-3 mr-1"}),m.location]})]}),e.jsxs("div",{className:"flex items-center justify-between mt-1",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:Z(m.created_at)}),m.profiles&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["by ",ne.getDisplayName(m.profiles)]})]})]})]},m.id)):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(ie,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"No recent listings found"}),e.jsx(T,{variant:"outline",size:"sm",className:"mt-2",onClick:te,children:"Post the first listing"})]})})]})}),e.jsx(G,{value:"activity",className:"mt-6",children:e.jsx(ce,{fallback:e.jsx(y,{children:e.jsx(w,{className:"p-6 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"Recent activity temporarily unavailable"})})}),children:e.jsx(ht,{showHeader:!1})})})]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(y,{className:"border-0 shadow-md",children:[e.jsx(L,{className:"pb-4",children:e.jsxs(D,{className:"text-lg font-semibold flex items-center",children:[e.jsx(B,{className:"h-5 w-5 mr-2 text-purple-500"}),"Upcoming Events"]})}),e.jsxs(w,{className:"space-y-3",children:[C?e.jsx("div",{className:"space-y-3",children:[...Array(3)].map((m,v)=>e.jsxs("div",{className:"p-3 rounded-lg border border-border animate-pulse",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4 mb-2"}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("div",{className:"h-3 bg-gray-200 rounded w-1/3"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded w-1/4"})]})]},v))}):_.length>0?_.map(m=>e.jsxs("div",{className:"p-3 rounded-lg border border-border hover:border-primary/40 transition-colors duration-200 cursor-pointer",onClick:()=>i("/events"),children:[e.jsx("h4",{className:"font-medium text-foreground text-sm",children:m.title}),e.jsxs("div",{className:"flex items-center justify-between mt-2 text-xs text-muted-foreground",children:[e.jsxs("span",{children:[Le(m.date)," at ",m.time]}),e.jsxs("span",{className:"flex items-center",children:[e.jsx(W,{className:"h-3 w-3 mr-1"}),m.location]})]}),m.profiles&&e.jsxs("div",{className:"mt-1 text-xs text-muted-foreground",children:["by ",ne.getDisplayName(m.profiles)]})]},m.id)):e.jsxs("div",{className:"text-center py-6",children:[e.jsx(B,{className:"h-8 w-8 text-muted-foreground mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"No upcoming events"}),e.jsx(T,{variant:"outline",size:"sm",onClick:se,children:"Create an event"})]}),_.length>0&&e.jsx(T,{variant:"ghost",size:"sm",className:"w-full text-primary hover:text-primary/80",onClick:Pe,children:"View All Events"})]})]}),e.jsxs(y,{className:"border-0 shadow-md",children:[e.jsx(L,{className:"pb-4",children:e.jsxs(D,{className:"text-lg font-semibold flex items-center",children:[e.jsx(st,{className:"h-5 w-5 mr-2 text-primary"}),"Community Activity"]})}),e.jsxs(w,{className:"space-y-4",children:[C?e.jsx("div",{className:"space-y-4",children:[...Array(3)].map((m,v)=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/2"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-8"})]},v))}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Active Listings"}),e.jsx("span",{className:"font-semibold text-primary",children:F.activeListings})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"This Week's Events"}),e.jsx("span",{className:"font-semibold text-purple-500",children:F.weeklyEvents})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"New Members"}),e.jsx("span",{className:"font-semibold text-primary/80",children:F.newMembers})]})]}),e.jsx("div",{className:"pt-2 border-t border-border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ye,{className:"h-4 w-4 text-primary"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Live updates enabled"})]}),e.jsx("div",{className:"flex items-center space-x-1",children:p?e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}):e.jsx("div",{className:"w-2 h-2 bg-red-500 rounded-full"})})]})})]})]})]})]})]})]}):null};export{At as default};
