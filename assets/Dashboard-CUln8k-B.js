import{a as Ve,m as he,n as ze,b as Fe,j as e,o as Oe,P as z,p as qe,I as Be,f as B,d as We}from"./ui-JykPZCXU.js";import{r as d}from"./vendor-o8UMtg5z.js";import{B as E}from"./input-Y27Ukfeg.js";import{C as y,a as w,b as T,c as L}from"./card-D3n9XfdJ.js";import{c as F,a as J,s as b,b as Y,u as xe,d as He}from"./index-Xla51Co3.js";import{n as oe,M as pe,H as fe,A as Ge,b as Ke,c as Je,U as ge,B as Ye,N as Qe,P as Xe,a as W,L as le,d as Ze}from"./Navbar-DN0c9AM8.js";import{E as I}from"./eye-DKcQtfPS.js";import{U as et,R as tt,E as st,a as de}from"./ErrorBoundary-B3hxSvuK.js";import{S as at}from"./scroll-area-CkngSAPi.js";import{f as ue,S as nt}from"./timeUtils-B3Mv27P7.js";import{a as be}from"./router-CRfqy20j.js";import{M as H}from"./map-pin-DS8IMhAL.js";import"./supabase-DllsxF6L.js";import"./utils-Bsf8JV-l.js";import"./index-BdQq_4o_.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const me=F("Activity",[["path",{d:"M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2",key:"169zse"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rt=F("TrendingUp",[["polyline",{points:"22 7 13.5 15.5 8.5 10.5 2 17",key:"126l90"}],["polyline",{points:"16 7 22 7 22 13",key:"kwv8wd"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const it=F("WifiOff",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}],["path",{d:"M5 12.859a10 10 0 0 1 5.17-2.69",key:"1dl1wf"}],["path",{d:"M19 12.859a10 10 0 0 0-2.007-1.523",key:"4k23kn"}],["path",{d:"M2 8.82a15 15 0 0 1 4.177-2.643",key:"1grhjp"}],["path",{d:"M22 8.82a15 15 0 0 0-11.288-3.764",key:"z3jwby"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ct=F("Wifi",[["path",{d:"M12 20h.01",key:"zekei9"}],["path",{d:"M2 8.82a15 15 0 0 1 20 0",key:"dnpr2z"}],["path",{d:"M5 12.859a10 10 0 0 1 14 0",key:"1x1e6c"}],["path",{d:"M8.5 16.429a5 5 0 0 1 7 0",key:"1bycff"}]]);var Q="Tabs",[ot,Pt]=Ve(Q,[he]),ve=he(),[lt,X]=ot(Q),je=d.forwardRef((n,a)=>{const{__scopeTabs:t,value:s,onValueChange:r,defaultValue:i,orientation:c="horizontal",dir:x,activationMode:p="automatic",...m}=n,u=ze(x),[h,f]=Fe({prop:s,onChange:r,defaultProp:i});return e.jsx(lt,{scope:t,baseId:Oe(),value:h,onValueChange:f,orientation:c,dir:u,activationMode:p,children:e.jsx(z.div,{dir:u,"data-orientation":c,...m,ref:a})})});je.displayName=Q;var ye="TabsList",we=d.forwardRef((n,a)=>{const{__scopeTabs:t,loop:s=!0,...r}=n,i=X(ye,t),c=ve(t);return e.jsx(qe,{asChild:!0,...c,orientation:i.orientation,dir:i.dir,loop:s,children:e.jsx(z.div,{role:"tablist","aria-orientation":i.orientation,...r,ref:a})})});we.displayName=ye;var Ne="TabsTrigger",_e=d.forwardRef((n,a)=>{const{__scopeTabs:t,value:s,disabled:r=!1,...i}=n,c=X(Ne,t),x=ve(t),p=Ce(c.baseId,s),m=Ee(c.baseId,s),u=s===c.value;return e.jsx(Be,{asChild:!0,...x,focusable:!r,active:u,children:e.jsx(z.button,{type:"button",role:"tab","aria-selected":u,"aria-controls":m,"data-state":u?"active":"inactive","data-disabled":r?"":void 0,disabled:r,id:p,...i,ref:a,onMouseDown:B(n.onMouseDown,h=>{!r&&h.button===0&&h.ctrlKey===!1?c.onValueChange(s):h.preventDefault()}),onKeyDown:B(n.onKeyDown,h=>{[" ","Enter"].includes(h.key)&&c.onValueChange(s)}),onFocus:B(n.onFocus,()=>{const h=c.activationMode!=="manual";!u&&!r&&h&&c.onValueChange(s)})})})});_e.displayName=Ne;var ke="TabsContent",Se=d.forwardRef((n,a)=>{const{__scopeTabs:t,value:s,forceMount:r,children:i,...c}=n,x=X(ke,t),p=Ce(x.baseId,s),m=Ee(x.baseId,s),u=s===x.value,h=d.useRef(u);return d.useEffect(()=>{const f=requestAnimationFrame(()=>h.current=!1);return()=>cancelAnimationFrame(f)},[]),e.jsx(We,{present:r||u,children:({present:f})=>e.jsx(z.div,{"data-state":u?"active":"inactive","data-orientation":x.orientation,role:"tabpanel","aria-labelledby":p,hidden:!f,id:m,tabIndex:0,...c,ref:a,style:{...n.style,animationDuration:h.current?"0s":void 0},children:f&&i})})});Se.displayName=ke;function Ce(n,a){return`${n}-trigger-${a}`}function Ee(n,a){return`${n}-content-${a}`}var dt=je,Te=we,Le=_e,Ie=Se;const ut=dt,De=d.forwardRef(({className:n,...a},t)=>e.jsx(Te,{ref:t,className:J("inline-flex h-10 items-center justify-center rounded-md bg-muted p-1 text-muted-foreground",n),...a}));De.displayName=Te.displayName;const G=d.forwardRef(({className:n,...a},t)=>e.jsx(Le,{ref:t,className:J("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-background data-[state=active]:text-foreground data-[state=active]:shadow-sm",n),...a}));G.displayName=Le.displayName;const K=d.forwardRef(({className:n,...a},t)=>e.jsx(Ie,{ref:t,className:J("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",n),...a}));K.displayName=Ie.displayName;const V={async logInteraction(n){const{data:a,error:t}=await b.from("user_interactions").insert(n).select("*").single();return{data:a,error:t}},async trackView(n,a,t){const{data:{user:s}}=await b.auth.getUser();!s||s.id===t||await this.logInteraction({user_id:s.id,post_id:n,post_type:a,interaction_type:"view",metadata:{timestamp:new Date().toISOString()}})},async trackContact(n,a,t,s,r){const{data:{user:i}}=await b.auth.getUser();if(i&&(await this.logInteraction({user_id:i.id,post_id:n,post_type:a,interaction_type:"contact",metadata:{contact_method:s,timestamp:new Date().toISOString()}}),t!==i.id)){const{data:c}=await b.from("profiles").select("username, full_name").eq("id",i.id).single(),x=c?.full_name||c?.username||"Someone";await oe.createNotification({user_id:t,type:"contact",title:`${x} wants to contact you!`,message:`${x} is interested in contacting you about "${r||"your post"}"`,data:{post_id:n,post_type:a,post_title:r,contact_method:s,interested_user_id:i.id}})}},async trackInterest(n,a,t,s){const{data:{user:r}}=await b.auth.getUser();if(r&&(await this.logInteraction({user_id:r.id,post_id:n,post_type:a,interaction_type:"interest",metadata:{timestamp:new Date().toISOString()}}),t!==r.id)){const{data:i}=await b.from("profiles").select("username, full_name").eq("id",r.id).single(),c=i?.full_name||i?.username||"Someone";await oe.createNotification({user_id:t,type:"interest",title:`${c} is interested in your ${a}!`,message:`${c} showed interest in "${s||"your post"}"`,data:{post_id:n,post_type:a,post_title:s,interested_user_id:r.id}})}},async trackProfileView(n){const{data:{user:a}}=await b.auth.getUser();!a||a.id===n||await this.logInteraction({user_id:a.id,post_id:n,post_type:"listing",interaction_type:"profile_view",metadata:{timestamp:new Date().toISOString()}})},async getRecentActivity(n,a=20){const{data:t}=await b.from("listings").select("id, title, user_id").eq("user_id",n),{data:s}=await b.from("events").select("id, title, user_id").eq("user_id",n),r=[...(t||[]).map(p=>p.id),...(s||[]).map(p=>p.id)];if(r.length===0)return{data:[],error:null};const{data:i,error:c}=await b.from("user_interactions").select(`
        *,
        profiles:user_id (
          id,
          username,
          full_name,
          avatar_url
        )
      `).in("post_id",r).order("created_at",{ascending:!1}).limit(a);if(c)return{data:null,error:c};const x=[];for(const p of i||[]){let m="Unknown Post",u=n;const h=t?.find(v=>v.id===p.post_id),f=s?.find(v=>v.id===p.post_id);h?(m=h.title,u=h.user_id):f&&(m=f.title,u=f.user_id),x.push({id:p.id,user_id:p.user_id,post_id:p.post_id,post_type:p.post_type,post_title:m,post_owner_id:u,interaction_type:p.interaction_type,created_at:p.created_at,profiles:p.profiles})}return{data:x,error:null}},async getActivityStats(n){const{data:a}=await b.from("listings").select("id").eq("user_id",n),{data:t}=await b.from("events").select("id").eq("user_id",n),s=[...(a||[]).map(m=>m.id),...(t||[]).map(m=>m.id)];if(s.length===0)return{data:{total_views:0,total_contacts:0,total_interests:0,recent_viewers:0},error:null};const{data:r}=await b.from("user_interactions").select("id",{count:"exact"}).in("post_id",s).eq("interaction_type","view"),{data:i}=await b.from("user_interactions").select("id",{count:"exact"}).in("post_id",s).eq("interaction_type","contact"),{data:c}=await b.from("user_interactions").select("id",{count:"exact"}).in("post_id",s).eq("interaction_type","interest"),x=new Date;x.setDate(x.getDate()-1);const{data:p}=await b.from("user_interactions").select("user_id",{count:"exact"}).in("post_id",s).eq("interaction_type","view").gte("created_at",x.toISOString());return{data:{total_views:r?.length||0,total_contacts:i?.length||0,total_interests:c?.length||0,recent_viewers:p?.length||0},error:null}},subscribeToInteractions(n,a){return b.channel(`user_interactions_${n}`).on("postgres_changes",{event:"*",schema:"public",table:"user_interactions",filter:`user_id=eq.${n}`},a).subscribe()},subscribeToPostInteractions(n,a){return b.channel("post_interactions").on("postgres_changes",{event:"*",schema:"public",table:"user_interactions",filter:`post_id=in.(${n.join(",")})`},a).subscribe()}},mt=({userId:n})=>{const{user:a}=Y(),[t,s]=d.useState({total_views:0,total_contacts:0,total_interests:0,recent_viewers:0}),[r,i]=d.useState(!0),c=n||a?.id,x=d.useCallback(async()=>{if(c)try{i(!0);const{data:m,error:u}=await V.getActivityStats(c);u?(console.error("Error fetching activity stats:",u),s({total_views:0,total_contacts:0,total_interests:0,recent_viewers:0})):s(m||{total_views:0,total_contacts:0,total_interests:0,recent_viewers:0})}catch(m){console.error("Unexpected error fetching activity stats:",m),s({total_views:0,total_contacts:0,total_interests:0,recent_viewers:0})}finally{i(!1)}},[c]);d.useEffect(()=>{x()},[x]),d.useEffect(()=>{if(!c)return;const m=V.subscribeToInteractions(c,u=>{console.log("Stats update from real-time interaction:",u),x()});return()=>{m.unsubscribe()}},[c,x]);const p=[{title:"Total Views",value:t.total_views,icon:I,color:"text-blue-600",bgColor:"bg-blue-50 dark:bg-blue-950"},{title:"Contacts",value:t.total_contacts,icon:pe,color:"text-green-600",bgColor:"bg-green-50 dark:bg-green-950"},{title:"Interests",value:t.total_interests,icon:fe,color:"text-red-600",bgColor:"bg-red-50 dark:bg-red-950"},{title:"Recent Viewers",value:t.recent_viewers,icon:et,color:"text-purple-600",bgColor:"bg-purple-50 dark:bg-purple-950"}];return r?e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[1,2,3,4].map(m=>e.jsx(y,{children:e.jsx(w,{className:"p-6",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4 mb-2"}),e.jsx("div",{className:"h-8 bg-gray-200 rounded w-1/2"})]})})},m))}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:p.map(m=>{const u=m.icon;return e.jsx(y,{className:"hover:shadow-md transition-shadow",children:e.jsx(w,{className:"p-6",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:m.title}),e.jsx("p",{className:"text-2xl font-bold",children:m.value.toLocaleString()})]}),e.jsx("div",{className:`p-3 rounded-full ${m.bgColor}`,children:e.jsx(u,{className:`h-6 w-6 ${m.color}`})})]})})},m.title)})})},ht=n=>{switch(n){case"view":return e.jsx(I,{className:"h-4 w-4"});case"contact":return e.jsx(pe,{className:"h-4 w-4"});case"interest":return e.jsx(fe,{className:"h-4 w-4"});case"profile_view":return e.jsx(ge,{className:"h-4 w-4"});default:return e.jsx(I,{className:"h-4 w-4"})}},xt=n=>{switch(n){case"view":return"bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300";case"contact":return"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300";case"interest":return"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300";case"profile_view":return"bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300";default:return"bg-gray-100 text-gray-800 dark:bg-gray-900 dark:text-gray-300"}},pt=n=>{switch(n){case"view":return"viewed";case"contact":return"contacted about";case"interest":return"showed interest in";case"profile_view":return"viewed your profile";default:return"interacted with"}},ft=({userId:n,limit:a=20,showHeader:t=!0})=>{const{user:s}=Y(),r=be(),{toast:i}=xe(),[c,x]=d.useState([]),[p,m]=d.useState(!0),[u,h]=d.useState(null),[f,v]=d.useState(new Date),N=n||s?.id,k=d.useCallback(async()=>{if(N)try{m(!0);const{data:g,error:j}=await V.getRecentActivity(N,a);j?(console.error("Error fetching activities:",j),h("Failed to load recent activity"),x([])):(x(g||[]),h(null),v(new Date))}catch(g){console.error("Unexpected error fetching activities:",g),h("Failed to load recent activity"),x([])}finally{m(!1)}},[N,a]);d.useEffect(()=>{k()},[k]),d.useEffect(()=>{if(!N)return;const g=V.subscribeToPostInteractions([],j=>{if(console.log("Real-time interaction update:",j),k(),j.eventType==="INSERT"&&j.new){const C=j.new;C.interaction_type==="view"?i({title:"New view on your post!",description:"Someone viewed one of your posts"}):C.interaction_type==="interest"?i({title:"Someone showed interest!",description:"Someone is interested in your post"}):C.interaction_type==="contact"&&i({title:"New contact!",description:"Someone contacted you about your post"})}});return()=>{g.unsubscribe()}},[N,k,i]);const U=()=>{k()},S=g=>{r(`/profile/${g}`)},D=(g,j)=>{r(j==="listing"?"/listings":"/events")};return p?e.jsxs(y,{children:[t&&e.jsx(T,{children:e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-5 w-5"}),"Recent Activity"]})}),e.jsx(w,{children:e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})})})]}):u?e.jsxs(y,{children:[t&&e.jsx(T,{children:e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-5 w-5"}),"Recent Activity"]})}),e.jsx(w,{children:e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:u})})]}):c.length===0?e.jsxs(y,{children:[t&&e.jsx(T,{children:e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-5 w-5"}),"Recent Activity"]})}),e.jsx(w,{children:e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:"No recent activity to show"})})]}):e.jsxs(y,{children:[t&&e.jsx(T,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(L,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"h-5 w-5"}),"Recent Activity"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Updated ",ue(f.toISOString())]}),e.jsx(E,{variant:"ghost",size:"sm",onClick:U,disabled:p,className:"h-8 w-8 p-0",children:e.jsx(tt,{className:`h-4 w-4 ${p?"animate-spin":""}`})})]})]})}),e.jsx(w,{className:"p-0",children:e.jsx(at,{className:"h-[400px]",children:e.jsx("div",{className:"p-4 space-y-4",children:c.map((g,j)=>e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsxs(Ge,{className:"h-8 w-8 cursor-pointer",onClick:()=>S(g.user_id),children:[e.jsx(Ke,{src:g.profiles?.avatar_url||void 0}),e.jsx(Je,{children:e.jsx(ge,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium text-sm",children:g.profiles?.full_name||g.profiles?.username||"Anonymous"}),e.jsxs(Ye,{variant:"secondary",className:`text-xs ${xt(g.interaction_type)}`,children:[ht(g.interaction_type),e.jsx("span",{className:"ml-1",children:pt(g.interaction_type)})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[g.interaction_type!=="profile_view"?e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:g.post_title}):e.jsx("p",{className:"text-sm text-muted-foreground",children:"Viewed your profile"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:ue(g.created_at)})]}),g.interaction_type!=="profile_view"&&e.jsx(E,{variant:"ghost",size:"sm",onClick:()=>D(g.post_id,g.post_type),className:"ml-2 flex-shrink-0",children:e.jsx(st,{className:"h-3 w-3"})})]})]})]}),j<c.length-1&&e.jsx(nt,{className:"mt-4"})]},g.id))})})})]})};class gt{channels=new Map;listeners=new Map;subscribeToUserInteractions(a,t){const s=`user_interactions_${a}`;if(!this.channels.has(s)){const i=b.channel(s).on("postgres_changes",{event:"*",schema:"public",table:"user_interactions",filter:`user_id=eq.${a}`},c=>{const x={type:"interaction",payload:c,timestamp:new Date().toISOString()};this.notifyListeners(s,x)}).subscribe();this.channels.set(s,i),this.listeners.set(s,new Set)}const r=this.listeners.get(s);return r.add(t),()=>{if(r.delete(t),r.size===0){const i=this.channels.get(s);i&&(i.unsubscribe(),this.channels.delete(s),this.listeners.delete(s))}}}subscribeToPostInteractions(a,t){const s=`post_interactions_${a.join("_")}`;if(!this.channels.has(s)){const i=b.channel(s).on("postgres_changes",{event:"*",schema:"public",table:"user_interactions",filter:`post_id=in.(${a.join(",")})`},c=>{const x={type:"interaction",payload:c,timestamp:new Date().toISOString()};this.notifyListeners(s,x)}).subscribe();this.channels.set(s,i),this.listeners.set(s,new Set)}const r=this.listeners.get(s);return r.add(t),()=>{if(r.delete(t),r.size===0){const i=this.channels.get(s);i&&(i.unsubscribe(),this.channels.delete(s),this.listeners.delete(s))}}}subscribeToListings(a){const t="listings_updates";if(!this.channels.has(t)){const r=b.channel(t).on("postgres_changes",{event:"*",schema:"public",table:"listings"},i=>{const c={type:"listing_update",payload:i,timestamp:new Date().toISOString()};this.notifyListeners(t,c)}).subscribe();this.channels.set(t,r),this.listeners.set(t,new Set)}const s=this.listeners.get(t);return s.add(a),()=>{if(s.delete(a),s.size===0){const r=this.channels.get(t);r&&(r.unsubscribe(),this.channels.delete(t),this.listeners.delete(t))}}}subscribeToEvents(a){const t="events_updates";if(!this.channels.has(t)){const r=b.channel(t).on("postgres_changes",{event:"*",schema:"public",table:"events"},i=>{const c={type:"event_update",payload:i,timestamp:new Date().toISOString()};this.notifyListeners(t,c)}).subscribe();this.channels.set(t,r),this.listeners.set(t,new Set)}const s=this.listeners.get(t);return s.add(a),()=>{if(s.delete(a),s.size===0){const r=this.channels.get(t);r&&(r.unsubscribe(),this.channels.delete(t),this.listeners.delete(t))}}}subscribeToProfiles(a){const t="profiles_updates";if(!this.channels.has(t)){const r=b.channel(t).on("postgres_changes",{event:"*",schema:"public",table:"profiles"},i=>{const c={type:"profile_update",payload:i,timestamp:new Date().toISOString()};this.notifyListeners(t,c)}).subscribe();this.channels.set(t,r),this.listeners.set(t,new Set)}const s=this.listeners.get(t);return s.add(a),()=>{if(s.delete(a),s.size===0){const r=this.channels.get(t);r&&(r.unsubscribe(),this.channels.delete(t),this.listeners.delete(t))}}}notifyListeners(a,t){const s=this.listeners.get(a);s&&s.forEach(r=>{try{r(t)}catch(i){console.error("Error in WebSocket listener:",i)}})}cleanup(){this.channels.forEach((a,t)=>{a.unsubscribe()}),this.channels.clear(),this.listeners.clear()}getConnectionStatus(){return"OPEN"}}const A=new gt,bt=(n={})=>{const{onMessage:a,onError:t,enabled:s=!0}=n,r=d.useRef([]),i=d.useCallback((u,h)=>{if(!s)return()=>{};const f=A.subscribeToUserInteractions(u,v=>{try{h?.(v),a?.(v)}catch(N){t?.(N)}});return r.current.push(f),f},[s,a,t]),c=d.useCallback((u,h)=>{if(!s||u.length===0)return()=>{};const f=A.subscribeToPostInteractions(u,v=>{try{h?.(v),a?.(v)}catch(N){t?.(N)}});return r.current.push(f),f},[s,a,t]),x=d.useCallback(u=>{if(!s)return()=>{};const h=A.subscribeToListings(f=>{try{u?.(f),a?.(f)}catch(v){t?.(v)}});return r.current.push(h),h},[s,a,t]),p=d.useCallback(u=>{if(!s)return()=>{};const h=A.subscribeToEvents(f=>{try{u?.(f),a?.(f)}catch(v){t?.(v)}});return r.current.push(h),h},[s,a,t]),m=d.useCallback(u=>{if(!s)return()=>{};const h=A.subscribeToProfiles(f=>{try{u?.(f),a?.(f)}catch(v){t?.(v)}});return r.current.push(h),h},[s,a,t]);return d.useEffect(()=>()=>{r.current.forEach(u=>{try{u()}catch(h){console.error("Error unsubscribing from WebSocket:",h)}}),r.current=[]},[]),{subscribeToUserInteractions:i,subscribeToPostInteractions:c,subscribeToListings:x,subscribeToEvents:p,subscribeToProfiles:m,connectionStatus:A.getConnectionStatus()}},vt=()=>{const{subscribeToListings:n,subscribeToEvents:a,subscribeToProfiles:t}=bt(),s=d.useCallback(c=>n(c),[n]),r=d.useCallback(c=>a(c),[a]),i=d.useCallback(c=>t(c),[t]);return{trackListings:s,trackEvents:r,trackProfiles:i}},Ut=()=>{const{user:n,username:a,profile:t,loading:s,profileLoading:r}=Y(),i=be(),{toast:c}=xe(),{trackListings:x,trackEvents:p}=vt(),{listings:m,events:u,loading:h,refreshData:f}=He(),[v,N]=d.useState([]),[k,U]=d.useState([]),[S,D]=d.useState(!0),[g,j]=d.useState(!0),[C,Z]=d.useState(new Date),[O,M]=d.useState({activeListings:0,weeklyEvents:0,newMembers:23}),ee=l=>{const o=new Date(l),_=Math.floor((new Date().getTime()-o.getTime())/(1e3*60*60));if(_<1)return"Just now";if(_<24)return`${_} hours ago`;const $=Math.floor(_/24);return $===1?"1 day ago":`${$} days ago`},Ae=l=>new Date(l).toLocaleDateString("en-US",{month:"short",day:"numeric"}),te=l=>l&&(l.full_name||l.username)||"Anonymous",se=d.useCallback(l=>l?l.map(o=>({id:o.id,title:o.title,description:o.description,price:o.price,location:o.location,category:o.category,image:o.image,user_id:o.user_id,created_at:o.created_at,updated_at:o.updated_at,profiles:o.profiles?{username:o.profiles.username||"",avatar_url:o.profiles.avatar_url||"",full_name:o.profiles.full_name||""}:null})):[],[]),ae=d.useCallback(l=>l?l.map(o=>({id:o.id,title:o.title,description:o.description,date:o.date,time:o.time,location:o.location,category:o.category,image:o.image,user_id:o.user_id,created_at:o.created_at,updated_at:o.updated_at,profiles:o.profiles?{username:o.profiles.username||"",avatar_url:o.profiles.avatar_url||"",full_name:o.profiles.full_name||""}:null})):[],[]),ne=d.useCallback(()=>{try{if(D(!0),m&&m.length>0){const o=se(m).slice(0,5);N(o),M(R=>({...R,activeListings:m.length}))}else N([]),M(l=>({...l,activeListings:0}));if(u&&u.length>0){const l=ae(u),o=new Date,R=l.filter(P=>new Date(P.date)>=o).slice(0,5);U(R);const _=new Date;_.setDate(_.getDate()+7);const $=l.filter(P=>{const ce=new Date(P.date);return ce>=o&&ce<=_}).length;M(P=>({...P,weeklyEvents:$}))}else U([]),M(l=>({...l,weeklyEvents:0}));Z(new Date),j(!0)}catch(l){console.error("Error processing data:",l),j(!1)}finally{D(!1)}},[m,u,se,ae]),Re=d.useCallback(async()=>{try{D(!0),await f(),c({title:"Data refreshed",description:"Dashboard content has been updated"})}catch(l){console.error("Error refreshing data:",l),c({title:"Refresh failed",description:"Failed to refresh dashboard data",variant:"destructive"})}},[f,c]),q=d.useCallback(()=>{Z(new Date),j(!0)},[]),re=()=>{i("/create-listing")},ie=()=>{i("/create-event")},Pe=()=>{i("/listings")},Ue=()=>{i("/events")},Me=()=>{i("/listings")},$e=()=>{i("/events")};return d.useEffect(()=>{!s&&!n&&i("/auth")},[n,s,i]),d.useEffect(()=>{h||ne()},[m,u,h,ne]),d.useEffect(()=>{D(h)},[h]),d.useEffect(()=>{if(!n)return;const l=x(q),o=p(q);return()=>{l(),o()}},[n,x,p,q]),d.useEffect(()=>{const o=setInterval(()=>{const _=new Date().getTime()-C.getTime()>5*60*1e3;j(!_)},3e4);return()=>clearInterval(o)},[C]),s?e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-32 w-32 border-b-2 border-nearnest-green"})}):n?e.jsxs("div",{className:"min-h-screen bg-background text-foreground",children:[e.jsx(Qe,{}),e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:[e.jsxs("div",{className:"mb-8 animate-fade-in",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h1",{className:"text-3xl font-bold text-foreground",children:"Welcome back! ðŸ‘‹"}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[g?e.jsx(ct,{className:"h-4 w-4 text-green-500"}):e.jsx(it,{className:"h-4 w-4 text-red-500"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:g?"Live":"Disconnected"})]}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Updated ",ee(C.toISOString())]}),e.jsx(E,{variant:"ghost",size:"sm",onClick:Re,disabled:S,className:"h-8 w-8 p-0",children:e.jsx(me,{className:`h-4 w-4 ${S?"animate-spin":""}`})})]})]}),a&&e.jsxs("p",{className:"text-lg text-muted-foreground mb-6",children:["Hello,"," ",e.jsx("span",{className:"font-semibold text-primary",children:a}),"! Ready to explore your neighborhood?"]}),e.jsx("p",{className:"text-muted-foreground",children:"Here's what's happening in your community today."})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8",children:[e.jsx(y,{className:"border-0 shadow-md hover:shadow-lg transition-all duration-300 cursor-pointer bg-gradient-to-br from-primary to-primary/80 hover:scale-105 animate-fade-in",onClick:re,children:e.jsx(w,{className:"p-6",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"w-12 h-12 bg-primary/60 rounded-xl flex items-center justify-center",children:e.jsx(Xe,{className:"h-6 w-6 text-primary-foreground"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-primary-foreground",children:"Post Listing"}),e.jsx("p",{className:"text-sm text-primary-foreground/80",children:"Sell something"})]})]})})}),e.jsx(y,{className:"border-0 shadow-md hover:shadow-lg transition-all duration-300 cursor-pointer bg-gradient-to-br from-emerald-500 to-teal-600 dark:from-slate-800 dark:to-blue-900 hover:scale-105 animate-fade-in",onClick:ie,style:{animationDelay:"0.1s"},children:e.jsx(w,{className:"p-6",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"w-12 h-12 bg-white/20 dark:bg-white/30 rounded-xl flex items-center justify-center",children:e.jsx(W,{className:"h-6 w-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-white",children:"Create Event"}),e.jsx("p",{className:"text-sm text-white/80 dark:text-white/90",children:"Host something"})]})]})})}),e.jsx(y,{className:"border-0 shadow-md hover:shadow-lg transition-all duration-300 cursor-pointer hover:scale-105 animate-fade-in",onClick:Pe,style:{animationDelay:"0.2s"},children:e.jsx(w,{className:"p-6",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"w-12 h-12 bg-primary rounded-xl flex items-center justify-center",children:e.jsx(le,{className:"h-6 w-6 text-primary-foreground"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-foreground",children:"Browse Items"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Find great deals"})]})]})})}),e.jsx(y,{className:"border-0 shadow-md hover:shadow-lg transition-all duration-300 cursor-pointer hover:scale-105 animate-fade-in",onClick:Ue,style:{animationDelay:"0.3s"},children:e.jsx(w,{className:"p-6",children:e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"w-12 h-12 bg-primary/80 rounded-xl flex items-center justify-center",children:e.jsx(H,{className:"h-6 w-6 text-primary-foreground"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-foreground",children:"Local Events"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Join activities"})]})]})})})]}),e.jsxs("div",{className:"mb-8 animate-fade-in",style:{animationDelay:"0.4s"},children:[e.jsxs("h2",{className:"text-2xl font-bold text-foreground mb-4 flex items-center gap-2",children:[e.jsx(me,{className:"h-6 w-6"}),"Your Activity"]}),e.jsx(de,{fallback:e.jsx(y,{children:e.jsx(w,{className:"p-6 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"Activity stats temporarily unavailable"})})}),children:e.jsx(mt,{})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8 animate-fade-in",style:{animationDelay:"0.5s"},children:[e.jsx("div",{className:"lg:col-span-2",children:e.jsxs(ut,{defaultValue:"listings",className:"w-full",children:[e.jsxs(De,{className:"grid w-full grid-cols-2",children:[e.jsx(G,{value:"listings",children:"Recent Listings"}),e.jsx(G,{value:"activity",children:"Recent Activity"})]}),e.jsx(K,{value:"listings",className:"mt-6",children:e.jsxs(y,{className:"border-0 shadow-md",children:[e.jsx(T,{className:"pb-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(L,{className:"text-xl font-semibold",children:"Recent Listings Near You"}),e.jsx(E,{variant:"ghost",size:"sm",className:"text-primary hover:text-primary/80",onClick:Me,children:"View All"})]})}),e.jsx(w,{className:"space-y-4",children:S?e.jsx("div",{className:"space-y-4",children:[...Array(3)].map((l,o)=>e.jsxs("div",{className:"flex items-center space-x-4 p-4 rounded-lg animate-pulse",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-200 rounded-lg"}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded w-1/2"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded w-1/4"})]})]},o))}):v.length>0?v.map(l=>e.jsxs("div",{className:"flex items-center space-x-4 p-4 rounded-lg hover:bg-accent/40 transition-colors duration-200 cursor-pointer",onClick:()=>i("/listings"),children:[e.jsx("img",{src:l.image||"https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=100&h=100&fit=crop",alt:l.title,className:"w-16 h-16 object-cover rounded-lg",onError:o=>{o.target.src="https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=100&h=100&fit=crop"}}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-medium text-foreground truncate",children:l.title}),e.jsxs("div",{className:"flex items-center space-x-4 mt-1",children:[e.jsxs("span",{className:"text-lg font-semibold text-primary",children:["$",l.price]}),e.jsxs("span",{className:"text-sm text-muted-foreground flex items-center",children:[e.jsx(H,{className:"h-3 w-3 mr-1"}),l.location]})]}),e.jsxs("div",{className:"flex items-center justify-between mt-1",children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:ee(l.created_at)}),l.profiles&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["by ",te(l.profiles)]})]})]})]},l.id)):e.jsxs("div",{className:"text-center py-8",children:[e.jsx(le,{className:"h-12 w-12 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"No recent listings found"}),e.jsx(E,{variant:"outline",size:"sm",className:"mt-2",onClick:re,children:"Post the first listing"})]})})]})}),e.jsx(K,{value:"activity",className:"mt-6",children:e.jsx(de,{fallback:e.jsx(y,{children:e.jsx(w,{className:"p-6 text-center",children:e.jsx("p",{className:"text-muted-foreground",children:"Recent activity temporarily unavailable"})})}),children:e.jsx(ft,{showHeader:!1})})})]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs(y,{className:"border-0 shadow-md",children:[e.jsx(T,{className:"pb-4",children:e.jsxs(L,{className:"text-lg font-semibold flex items-center",children:[e.jsx(W,{className:"h-5 w-5 mr-2 text-purple-500"}),"Upcoming Events"]})}),e.jsxs(w,{className:"space-y-3",children:[S?e.jsx("div",{className:"space-y-3",children:[...Array(3)].map((l,o)=>e.jsxs("div",{className:"p-3 rounded-lg border border-border animate-pulse",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4 mb-2"}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("div",{className:"h-3 bg-gray-200 rounded w-1/3"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded w-1/4"})]})]},o))}):k.length>0?k.map(l=>e.jsxs("div",{className:"p-3 rounded-lg border border-border hover:border-primary/40 transition-colors duration-200 cursor-pointer",onClick:()=>i("/events"),children:[e.jsx("h4",{className:"font-medium text-foreground text-sm",children:l.title}),e.jsxs("div",{className:"flex items-center justify-between mt-2 text-xs text-muted-foreground",children:[e.jsxs("span",{children:[Ae(l.date)," at ",l.time]}),e.jsxs("span",{className:"flex items-center",children:[e.jsx(H,{className:"h-3 w-3 mr-1"}),l.location]})]}),l.profiles&&e.jsxs("div",{className:"mt-1 text-xs text-muted-foreground",children:["by ",te(l.profiles)]})]},l.id)):e.jsxs("div",{className:"text-center py-6",children:[e.jsx(W,{className:"h-8 w-8 text-muted-foreground mx-auto mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"No upcoming events"}),e.jsx(E,{variant:"outline",size:"sm",onClick:ie,children:"Create an event"})]}),k.length>0&&e.jsx(E,{variant:"ghost",size:"sm",className:"w-full text-primary hover:text-primary/80",onClick:$e,children:"View All Events"})]})]}),e.jsxs(y,{className:"border-0 shadow-md",children:[e.jsx(T,{className:"pb-4",children:e.jsxs(L,{className:"text-lg font-semibold flex items-center",children:[e.jsx(rt,{className:"h-5 w-5 mr-2 text-primary"}),"Community Activity"]})}),e.jsxs(w,{className:"space-y-4",children:[S?e.jsx("div",{className:"space-y-4",children:[...Array(3)].map((l,o)=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/2"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-8"})]},o))}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Active Listings"}),e.jsx("span",{className:"font-semibold text-primary",children:O.activeListings})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"This Week's Events"}),e.jsx("span",{className:"font-semibold text-purple-500",children:O.weeklyEvents})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"New Members"}),e.jsx("span",{className:"font-semibold text-primary/80",children:O.newMembers})]})]}),e.jsx("div",{className:"pt-2 border-t border-border",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(Ze,{className:"h-4 w-4 text-primary"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Live updates enabled"})]}),e.jsx("div",{className:"flex items-center space-x-1",children:g?e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full animate-pulse"}):e.jsx("div",{className:"w-2 h-2 bg-red-500 rounded-full"})})]})})]})]})]})]})]})]}):null};export{Ut as default};
